---
name: Auto-Promote to Staging

on:
  push:
    branches: [develop]
  workflow_run:
    workflows: ["Quality Gates"]
    types: [completed]
    branches: [develop]

jobs:
  promote-to-staging:
    name: Promote develop → staging
    runs-on: ubuntu-latest
    # Only run if Quality Gates passed on develop
    if: |
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'develop') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/develop')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Check if promotion needed
        id: check
        run: |
          git fetch origin staging develop

          # Get commit SHAs
          DEVELOP_SHA=$(git rev-parse origin/develop)
          STAGING_SHA=$(git rev-parse origin/staging)

          echo "develop: $DEVELOP_SHA"
          echo "staging: $STAGING_SHA"

          # Check if staging is behind develop
          if git merge-base --is-ancestor origin/staging origin/develop; then
            if [ "$DEVELOP_SHA" != "$STAGING_SHA" ]; then
              echo "needs_promotion=true" >> $GITHUB_OUTPUT
              echo "Staging is behind develop - promotion needed"
            else
              echo "needs_promotion=false" >> $GITHUB_OUTPUT
              echo "Staging is up to date with develop"
            fi
          else
            echo "needs_promotion=false" >> $GITHUB_OUTPUT
            echo "Branches have diverged - manual merge required"
          fi

      - name: Promote to staging
        if: steps.check.outputs.needs_promotion == 'true'
        run: |
          git checkout staging
          git merge origin/develop --ff-only -m "chore: auto-promote develop to staging"
          git push origin staging
          echo "✓ Successfully promoted develop to staging"
